<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SRMU Web Chat</title>
<style>
:root{
  --bg:#f1f4f8; --panel:#ffffff;
  --self:#d8f8d2; --other:#e6f0ff;
  --admin:#ffe6e6; --welcome:#fff7cc;
  --accent:#2b7cff; --muted:#6b7280;
  --text:#111827; --radius:12px;
}
*{ box-sizing:border-box; }
body{
  margin:0; background:var(--bg);
  font-family:Inter,Arial; display:flex; justify-content:center; align-items:center;
  height:100vh; color:var(--text);
}
.chat{
  width:100%; max-width:980px; height:92vh;
  background:var(--panel); border-radius:12px;
  box-shadow:0 12px 30px rgba(25,35,45,0.08);
  display:flex; flex-direction:column; overflow:hidden;
}

/* HEADER */
.header{ padding:10px 16px; border-bottom:1px solid #e5eaf0; background:#fff; }
.header-row{ display:flex; justify-content:space-between; align-items:center; }
.online-box{ padding:6px 12px; background:#fff; border:1px solid #e5eaf0; border-radius:10px; font-weight:600; cursor:pointer; }
.title-wrap{ display:flex; flex-direction:column; align-items:center; }
.app-title{ font-size:20px; font-weight:700; }
.you-are{ font-size:13px; color:#6b7280; margin-top:2px; }
.right-wrap{ display:flex; gap:12px; align-items:center; }
.about-btn{ padding:6px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:13px; }
.github-icon{ width:36px; height:36px; border-radius:50%; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center; }

/* ONLINE POPUP */
.popup{ position:absolute; right:16px; top:95px; width:260px; background:#fff; border-radius:10px; box-shadow:0 12px 40px rgba(0,0,0,0.15); display:none; z-index:50; }
.popup-header{ padding:10px 12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; }
.close-btn{ cursor:pointer; font-size:18px; }
.popup-list div{ padding:8px 12px; border-bottom:1px solid #f5f5f5; display:flex; justify-content:space-between; }

/* ADMIN PANEL */
.admin-panel{ padding:10px; display:none; gap:8px; border-bottom:1px solid #e5eaf0; }
.admin-panel button{ padding:6px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; }

/* MESSAGES */
.messages{ flex:1; padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px; }
.event{ text-align:center; font-size:13px; color:var(--muted); }

.msg-row{ display:flex; }
.left{ justify-content:flex-start; }
.right{ justify-content:flex-end; }

.bubble{ max-width:75%; padding:10px 14px; border-radius:var(--radius); box-shadow:0 4px 16px rgba(0,0,0,0.06); }
.self{ background:var(--self); }
.other{ background:var(--other); }
.admin{ background:var(--admin); border-left:4px solid #ff6b6b; }
.welcome{ background:var(--welcome); }
.dm{ border:2px dashed rgba(120,80,200,0.12); }

.meta{ display:flex; justify-content:space-between; margin-bottom:6px; font-size:12px; }
.meta-name{ font-weight:600; }
.meta-time{ color:var(--muted); }

.typing{ height:18px; padding-left:16px; color:var(--muted); }

/* COMPOSER */
.composer{
  padding:10px 14px;
  display:flex;
  align-items:center;
  gap:10px;
  border-top:1px solid #e5eaf0;
  background:#fafbfd;
}
.composer input{
  flex:1;
  padding:12px 16px;
  border-radius:14px;
  border:1px solid #cfd6df;
  background:#fff;
  font-size:15px;
}
.composer button{
  background:var(--accent);
  padding:10px 20px;
  border:none;
  border-radius:14px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
}

/* EMOJI POPUP */
.emoji-btn{
  width:44px; height:44px;
  border-radius:14px; background:#fff;
  border:1px solid #d7dce3; font-size:22px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.emoji-popup{
  position:absolute; bottom:90px; left:20px;
  background:#fff; border:1px solid #ddd; border-radius:12px;
  padding:10px; display:none;
}
.emoji-popup span{
  font-size:24px; padding:6px; cursor:pointer;
}

/* DM TAG */
#dmHolder{ display:none; align-items:center; }
.dm-tag{
  padding:6px 12px; background:#f3e8ff; border-radius:10px;
  border:1px solid #e8d7ff; font-weight:600;
}
.cancel-dm{ margin-left:8px; color:#d54949; cursor:pointer; }

/* REACTIONS */
.reaction-popup{
  position:absolute;
  background:#fff;
  padding:6px 10px;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
  display:flex;
  gap:8px;
  z-index:80;
  font-size:22px;
  display:none;
}
.reaction-popup span{
  cursor:pointer;
}
.reaction-bar{
  display:flex;
  gap:6px;
  margin-top:6px;
}
.reaction-chip{
  padding:2px 6px;
  background:#f0f2f5;
  border-radius:8px;
  font-size:13px;
}
</style>
</head>
<body>

<!-- REACTION POPUP -->
<div id="reactionPopup" class="reaction-popup">
  <span data-r="ğŸ‘">ğŸ‘</span>
  <span data-r="â¤ï¸">â¤ï¸</span>
  <span data-r="ğŸ˜‚">ğŸ˜‚</span>
  <span data-r="ğŸ˜®">ğŸ˜®</span>
  <span data-r="ğŸ˜¢">ğŸ˜¢</span>
  <span data-r="ğŸ˜¡">ğŸ˜¡</span>
</div>

<div class="chat">

  <!-- HEADER -->
  <div class="header">
    <div class="header-row">
      <div id="onlineBox" class="online-box">0 online</div>

      <div class="title-wrap">
        <div class="app-title">SRMU Web Chat</div>
        <div id="youAre" class="you-are"></div>
      </div>

      <div class="right-wrap">
        <button id="aboutBtn" class="about-btn">About</button>
        <a href="https://github.com/webdevpraveen" target="_blank" class="github-icon">
          <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 0C3.58 0 0 3.58 0 8a8 
            8 0 005.47 7.59c.4.07.55-.17.55-.38 
            0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
            -.01-.53.63-.01 1.08.58 1.23.82.72 
            1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 
            0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 
            0 0 .67-.21 2.2.82a7.65 7.65 0 
            012 0c1.53-1.04 2.2-.82 2.2-.82.44 
            1.1.16 1.92.08 2.12.51.56.82 1.27.82 
            2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 
            1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8 
            8 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <!-- POPUP -->
  <div id="popup" class="popup">
    <div class="popup-header">
      Online Users
      <div id="closePopup" class="close-btn">Ã—</div>
    </div>
    <div id="popupList" class="popup-list"></div>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" class="admin-panel">
    <button id="clearChat">Clear</button>
    <button id="muteAll">Mute</button>
    <button id="unmuteAll">Unmute</button>
  </div>

  <!-- MESSAGES -->
  <div id="messages" class="messages"></div>
  <div id="typing" class="typing"></div>

  <!-- COMPOSER -->
  <div class="composer">

    <div id="emojiBtn" class="emoji-btn">ğŸ˜Š</div>

    <div id="emojiPopup" class="emoji-popup">
      <span>ğŸ˜€</span><span>ğŸ˜</span><span>ğŸ˜‚</span><span>ğŸ¤£</span>
      <span>ğŸ˜</span><span>ğŸ˜</span><span>ğŸ˜­</span><span>ğŸ‘€</span>
      <span>ğŸ¤”</span><span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ‘‹</span>
    </div>

    <div id="dmHolder">
      <span id="dmTag" class="dm-tag"></span>
      <span id="dmCancel" class="cancel-dm">âœ–</span>
    </div>

    <input id="input" placeholder="Type your message..." />
    <button id="send">Send</button>

  </div>
</div>

<audio id="notif" src="notification.mp3" preload="auto"></audio>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const socket = io("https://wdp-chat.onrender.com");

let userId = localStorage.getItem("uid");
if(!userId){
  userId = "User-" + Math.floor(10000 + Math.random()*90000);
  localStorage.setItem("uid",userId);
}
youAre.textContent = "You are: " + userId;

const messages=document.getElementById("messages");
const typing=document.getElementById("typing");
const popup=document.getElementById("popup");
const popupList=document.getElementById("popupList");
const notif=document.getElementById("notif");
const dmHolder=document.getElementById("dmHolder");
const dmTag=document.getElementById("dmTag");
const dmCancel=document.getElementById("dmCancel");
let dmTarget=null;

const nameColors={};
const pastel=["#8e7dff","#ff7dcf","#ffb877","#77baff","#74d39c","#ff8f8f","#b785ff","#8fd1ff"];
function nameColor(uid){ if(nameColors[uid]) return nameColors[uid]; return nameColors[uid]=pastel[Math.floor(Math.random()*pastel.length)]; }

let soundReady=false;
window.addEventListener("click",()=>{ 
  if(!soundReady){ notif.play().then(()=>{notif.pause();notif.currentTime=0; soundReady=true; }); }
});

const params=new URLSearchParams(location.search);
const isAdmin=params.get("admin")==="supersecret123";
if(isAdmin) adminPanel.style.display="flex";

socket.emit("userConnected",userId);

send.onclick=()=>{
  const t=input.value.trim();
  if(!t) return;

  if(dmTarget){
    socket.emit("privateMessage",{from:userId,to:dmTarget,text:t});
  } else {
    socket.emit("chatMessage",{userId,text:t});
  }
  input.value="";
  socket.emit("stopTyping",userId);
};

input.addEventListener("keydown",e=>{ if(e.key==="Enter") send.click(); });

let timer;
input.addEventListener("input",()=>{
  socket.emit("typing",userId);
  clearTimeout(timer);
  timer=setTimeout(()=>socket.emit("stopTyping",userId),500);
});

/* ADD MESSAGE */
function addMsg(m){
  const row=document.createElement("div");
  row.className="msg-row "+((m.userId===userId||(m.from&&m.from===userId))?"right":"left");

  const b=document.createElement("div");
  b.className="bubble";

  if(m.isWelcome) b.classList.add("welcome");
  else if(m.isAdmin) b.classList.add("admin");
  else if(m.isDM) b.classList.add("dm");
  else if(m.userId===userId) b.classList.add("self");
  else b.classList.add("other");

  const meta=document.createElement("div");
  meta.className="meta";

  const name=document.createElement("div");
  name.className="meta-name";
  name.textContent=m.from? (m.from===userId?"You":m.from) : (m.userId===userId?"You":m.userId);
  if(name.textContent!=="You") name.style.color=nameColor(name.textContent);

  const time=document.createElement("div");
  time.className="meta-time";
  time.textContent=m.timestamp || "";

  meta.appendChild(name);
  meta.appendChild(time);

  const body=document.createElement("div");

  if(m.isDM){
    const note=document.createElement("div");
    note.style.fontSize="12px"; 
    note.style.color="var(--muted)";
    note.style.marginBottom="6px";
    note.textContent=m.from===userId? "(Private to "+m.to+")" : "(Private from "+m.from+")";
    body.appendChild(note);
  }

  const txt=document.createElement("div");
  txt.textContent=m.text;
  body.appendChild(txt);

  b.appendChild(meta);
  b.appendChild(body);

  row.appendChild(b);
  messages.appendChild(row);
  messages.scrollTop=messages.scrollHeight;

  if((m.userId&&m.userId!==userId)||(m.from&&m.from!==userId)){
    if(soundReady){ notif.currentTime=0; notif.play(); }
  }

  /* === REACTIONS SYSTEM === */
  b.style.position="relative";

  const reactBar=document.createElement("div");
  reactBar.className="reaction-bar";
  b.appendChild(reactBar);

  m._reactions={};

  function updateReactions(){
    reactBar.innerHTML="";
    for(let emo in m._reactions){
      let count=m._reactions[emo].size;
      if(count>0){
        let chip=document.createElement("div");
        chip.className="reaction-chip";
        chip.textContent=emo+" "+count;
        reactBar.appendChild(chip);
      }
    }
  }

  function toggleReaction(uid, emo){
    if(!m._reactions[emo]) m._reactions[emo] = new Set();
    if(m._reactions[emo].has(uid)) m._reactions[emo].delete(uid);
    else m._reactions[emo].add(uid);
    updateReactions();
  }

  b.oncontextmenu = (e)=>{
    e.preventDefault();
    openReactionPopup(e, m);
  };
  b.onclick = (e)=>{
    if(e.shiftKey) openReactionPopup(e, m);
  };

  function openReactionPopup(e, message){
    const pop=document.getElementById("reactionPopup");
    pop.style.left=(e.pageX-60)+"px";
    pop.style.top=(e.pageY-50)+"px";
    pop.style.display="flex";

    [...pop.children].forEach(sp=>{
      sp.onclick=()=>{
        toggleReaction(userId, sp.dataset.r);
        pop.style.display="none";
      };
    });

    document.body.onclick=(ev)=>{
      if(!pop.contains(ev.target)) pop.style.display="none";
    };
  }
}

/* SOCKET LISTENERS */
socket.on("chatMessage", m=>addMsg(m));
socket.on("privateMessage", m=>addMsg(m));

socket.on("userTyping",uid=>{ if(uid!==userId) typing.textContent=uid+" is typing..."; });
socket.on("userStopTyping",()=>typing.textContent="");

socket.on("onlineList",(list)=>{
  onlineBox.textContent=list.length+" online";
  popupList.innerHTML="";
  list.forEach(u=>{
    const d=document.createElement("div");
    d.textContent=u;
    const btn=document.createElement("button");
    btn.className="msg-button";
    btn.textContent="Message";
    btn.onclick=()=>{
      if(u===userId) return alert("You can't DM yourself");
      dmTarget=u;
      dmTag.textContent="DM â†’ "+u;
      dmHolder.style.display="flex";
      input.focus();
    };
    d.appendChild(btn);
    popupList.appendChild(d);
  });
});

/* DM cancel */
dmCancel.onclick=()=>{ dmTarget=null; dmHolder.style.display="none"; };

/* Admin */
clearChat.onclick=()=> socket.emit("adminClearChat");
muteAll.onclick=()=> socket.emit("adminMuteAll");
unmuteAll.onclick=()=> socket.emit("adminUnmuteAll");

socket.on("clearChatNow",()=> messages.innerHTML="");
socket.on("muteAllNow",()=>{ const e=document.createElement("div"); e.className="event"; e.textContent="ğŸ”‡ Admin muted all users"; messages.appendChild(e); });
socket.on("unmuteAllNow",()=>{ const e=document.createElement("div"); e.className="event"; e.textContent="ğŸ”Š Admin unmuted users"; messages.appendChild(e); });

onlineBox.onclick=()=> popup.style.display="block";
closePopup.onclick=()=> popup.style.display="none";
</script>
</body>
</html>
