<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SRMU Web Chat</title>
<style>
:root{
  --bg:#f1f4f8; --panel:#ffffff; --self:#d8f8d2; --other:#e6f0ff;
  --admin:#ffe6e6; --welcome:#fff7cc; --accent:#2b7cff; --muted:#6b7280;
  --text:#111827; --radius:12px;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg);
  font-family:Inter,Arial,Helvetica,sans-serif;
  display:flex; align-items:center; justify-content:center;
  height:100vh; color:var(--text);
}
.chat-box{
  width:100%; max-width:980px; height:92vh;
  background:var(--panel);
  border-radius:12px; box-shadow:0 10px 30px rgba(10,20,30,0.06);
  display:grid; grid-template-columns: 1fr 320px;
  gap:20px; padding:18px;
}
.left{
  display:flex; flex-direction:column;
  border-radius:12px; overflow:hidden;
}
.header{
  padding:12px 16px; display:flex;
  align-items:center; justify-content:space-between; gap:12px;
}
.header-left{ display:flex; flex-direction:column; gap:2px; }
.app-title{ font-weight:700; font-size:18px; }
.you-id{ font-size:13px; color:var(--muted); }
.header-center{ text-align:center; flex:1; }
.header-right{ display:flex; gap:12px; align-items:center; }
.github-link{
  display:flex; align-items:center; justify-content:center;
  width:34px; height:34px; border-radius:50%;
  background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.04);
}
.online-count{
  font-weight:600; cursor:pointer;
  padding:6px 8px; border-radius:8px;
  background:#fff; border:1px solid #eef2f7;
}
.online-popup{
  position:absolute; right:22px; top:72px;
  width:220px; background:#fff;
  border-radius:10px; box-shadow:0 12px 40px rgba(10,20,30,0.12);
  display:none; z-index:60;
}
.online-popup div{
  padding:8px 10px; border-bottom:1px solid #f1f5f9;
}
#pinnedBar{
  display:none; background:#fafbfd;
  border-radius:8px; padding:10px 14px;
  margin:0 16px 8px 16px; font-weight:600;
}
.messages{
  flex:1; overflow:auto; padding:18px;
  display:flex; flex-direction:column; gap:12px;
}
.event{
  text-align:center; color:var(--muted); font-size:13px;
}
.row{ display:flex; }
.left-row{ justify-content:flex-start; }
.right-row{ justify-content:flex-end; }
.bubble{
  max-width:75%; padding:10px 14px;
  border-radius:12px; font-size:14px;
  box-shadow:0 4px 18px rgba(10,20,30,0.04);
}
.self{ background:var(--self); border-bottom-right:6px solid rgba(0,0,0,0.03); }
.other{ background:var(--other); }
.admin{ background:var(--admin); border-left:4px solid #ff6b6b; }
.welcome{ background:var(--welcome); }
.meta{
  display:flex; justify-content:space-between;
  gap:12px; margin-bottom:8px;
  color:var(--muted); font-size:12px;
}
.meta .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%; }
.meta .time{ font-size:11px; }
.composer{
  padding:12px 16px; border-top:1px solid #eef2f7;
  display:flex; gap:10px;
}
.composer input{
  flex:1; padding:12px 14px;
  border-radius:999px; border:1px solid #e6eef6;
  outline:none; font-size:14px;
}
.composer button{
  padding:10px 14px; border-radius:999px;
  background:var(--accent); border:none;
  color:#fff; cursor:pointer; font-weight:600;
}
.right{
  padding:12px; border-radius:12px;
  background:var(--panel);
  box-shadow:0 10px 30px rgba(10,20,30,0.04);
  display:flex; flex-direction:column; gap:12px;
}
.right h4{ margin:0; font-size:14px; }
.online-list{
  display:flex; flex-direction:column;
  gap:8px; overflow:auto;
  max-height:60vh; padding-top:6px;
}
.user-item{
  display:flex; align-items:center;
  justify-content:space-between;
  gap:10px; padding:8px;
  border-radius:8px; background:#fbfdff;
  border:1px solid #f1f6fb;
}
.user-left{ display:flex; gap:10px; align-items:center; }
.avatar{
  width:36px; height:36px; border-radius:50%;
  display:grid; place-items:center;
  background:#eef6ff; color:#1f3b82; font-weight:700;
}
.user-actions button{
  padding:6px 8px; border-radius:8px;
  border:1px solid #eef2f7;
  background:#fff; cursor:pointer; font-size:13px;
}
.small-muted{ color:var(--muted); font-size:13px; }
@media(max-width:900px){
  .chat-box{ grid-template-columns:1fr; padding:12px; gap:12px; }
  .right{ order:2; height:auto; }
  .left{ order:1; }
  .online-popup{ right:10px; top:86px; }
  .app-title{ font-size:16px; }
  .messages{ padding:12px; }
}
</style>
</head>

<body>

<div class="chat-box">

  <div class="left">

    <div class="header">
      <div class="header-left">
        <div id="youId" class="you-id"></div>
      </div>

      <div class="header-center">
        <div class="app-title">SRMU Web Chat</div>
      </div>

      <div class="header-right">
        <a class="github-link" href="https://github.com/webdevpraveen" target="_blank">
          <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8a8 
            8 0 005.47 7.59c.4.07.55-.17.55-.38 
            0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
            -.01-.53.63-.01 1.08.58 1.23.82.72 
            1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 
            0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 
            0 0 .67-.21 2.2.82a7.65 7.65 0 
            012 0c1.53-1.04 2.2-.82 2.2-.82.44 
            1.1.16 1.92.08 2.12.51.56.82 1.27.82 
            2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 
            1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8 
            8 0 0016 8c0-4.42-3.58-8-8-8z"/>
          </svg>
        </a>

        <div id="onlineCount" class="online-count">0 online</div>
      </div>
    </div>

    <div id="onlinePopup" class="online-popup"></div>

    <div id="pinnedBar">ðŸ“Œ <span id="pinnedText"></span></div>

    <div id="messages" class="messages"></div>
    <div id="typingStatus" style="padding:10px 18px; color:var(--muted); min-height:18px"></div>

    <div class="composer">
      <input id="input" placeholder="Type your message..." />
      <button id="send">Send</button>
    </div>

  </div>

  <div class="right">
    <h4>Online</h4>
    <div id="onlineList" class="online-list"></div>

    <div style="height:1px;background:#eef2f7;margin:6px 0"></div>

    <div style="display:flex;gap:8px;">
      <button id="clearChat" style="display:none">Clear</button>
      <button id="muteAll" style="display:none">Mute</button>
      <button id="unmuteAll" style="display:none">Unmute</button>
    </div>

    <div style="margin-top:auto" class="small-muted">SRMU Web Chat â€¢ v3.0</div>
  </div>

</div>

<audio id="notifSound" src="notification.mp3" preload="auto"></audio>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const socket = io("https://wdp-chat.onrender.com");
let userId = localStorage.getItem("userId");
if(!userId){ userId = "User-" + Math.floor(10000 + Math.random()*90000); localStorage.setItem("userId", userId); }
document.getElementById("youId").textContent = "You are: " + userId;

const messagesEl = document.getElementById("messages");
const typingStatus = document.getElementById("typingStatus");
const input = document.getElementById("input");
const notif = document.getElementById("notifSound");
const onlineCount = document.getElementById("onlineCount");
const onlinePopup = document.getElementById("onlinePopup");
const onlineListEl = document.getElementById("onlineList");
const pinnedBar = document.getElementById("pinnedBar");
const pinnedText = document.getElementById("pinnedText");
const clearBtn = document.getElementById("clearChat");
const muteBtn = document.getElementById("muteAll");
const unmuteBtn = document.getElementById("unmuteAll");

const isAdmin = new URLSearchParams(window.location.search).get("admin")==="supersecret123";
if(isAdmin){
  clearBtn.style.display="inline-block";
  muteBtn.style.display="inline-block";
  unmuteBtn.style.display="inline-block";
}

let soundEnabled = localStorage.getItem("soundEnabled")==="1";
function enableSound(){
  if(soundEnabled) return;
  try{
    notif.volume=1;
    notif.play().then(()=>{ notif.pause(); notif.currentTime=0; soundEnabled=true; localStorage.setItem("soundEnabled","1"); });
  }catch(e){}
}
const gesture=()=>{ enableSound(); window.removeEventListener("click",gesture); window.removeEventListener("keydown",gesture); };
window.addEventListener("click",gesture);
window.addEventListener("keydown",gesture);

socket.on("connect", ()=> socket.emit("userConnected", userId));

document.getElementById("send").onclick = ()=>{
  const txt = input.value.trim();
  if(!txt) return;
  socket.emit("chatMessage",{ userId,text:txt });
  input.value="";
  socket.emit("stopTyping", userId);
};

input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") document.getElementById("send").click(); });

let typingTimer;
input.addEventListener("input",()=>{
  socket.emit("typing", userId);
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>socket.emit("stopTyping",userId),600);
});

onlineCount.onclick = ()=> onlinePopup.style.display = onlinePopup.style.display==="block"?"none":"block";

function addMessage(msg){
  const row=document.createElement("div");
  row.className="row "+(msg.userId===userId?"right-row":"left-row");

  const b=document.createElement("div");
  b.className="bubble";

  if(msg.isWelcome) b.classList.add("welcome");
  else if(msg.userId==="System") b.classList.add("welcome");
  else if(msg.userId===userId) b.classList.add("self");
  else if(msg.isAdmin) b.classList.add("admin");
  else b.classList.add("other");

  const meta=document.createElement("div");
  meta.className="meta";

  const name=document.createElement("div");
  name.className="name";
  name.textContent = msg.userId==="System"?"System":(msg.userId===userId?"You":msg.userId);

  const time=document.createElement("div");
  time.className="time";
  time.textContent = msg.timestamp||"";

  meta.appendChild(name);
  meta.appendChild(time);

  const body=document.createElement("div");
  body.textContent=msg.text;

  b.appendChild(meta);
  b.appendChild(body);

  row.appendChild(b);
  messagesEl.appendChild(row);
  messagesEl.scrollTop=messagesEl.scrollHeight;

  if(msg.userId!==userId && !msg.isWelcome && localStorage.getItem("soundEnabled")==="1"){
    try{ notif.currentTime=0; notif.play(); }catch(e){}
  }
}

socket.on("chatMessage",(msg)=> addMessage(msg));

socket.on("userTyping",(uid)=>{
  if(uid===userId) return;
  typingStatus.textContent = uid + " is typing...";
});
socket.on("userStopTyping",()=> typingStatus.textContent="");

socket.on("onlineList",(list)=>{
  onlineListEl.innerHTML="";
  list.forEach(u=>{
    const item=document.createElement("div");
    item.className="user-item";

    const left=document.createElement("div");
    left.className="user-left";

    const av=document.createElement("div");
    av.className="avatar";
    av.textContent=u.replace(/[^A-Za-z0-9]/g,'').slice(0,2);

    const name=document.createElement("div");
    name.textContent=u;

    left.appendChild(av);
    left.appendChild(name);

    const actions=document.createElement("div");
    actions.className="user-actions";

    const c=document.createElement("button");
    c.textContent="Copy";
    c.onclick=()=>navigator.clipboard.writeText(u).then(()=>alert("Copied "+u));
    actions.appendChild(c);

    if(isAdmin){
      const k=document.createElement("button");
      k.textContent="Kick";
      k.onclick=()=>alert("Kick placeholder");
      actions.appendChild(k);
    }

    item.appendChild(left);
    item.appendChild(actions);
    onlineListEl.appendChild(item);
  });

  onlineCount.textContent=list.length+" online";

  onlinePopup.innerHTML="";
  list.forEach(u=>{
    const r=document.createElement("div");
    r.textContent=u;
    onlinePopup.appendChild(r);
  });
});

socket.on("userJoinedEvent",(uid)=>{
  const e=document.createElement("div");
  e.className="event";
  e.textContent="ðŸŸ¢ "+uid+" joined";
  messagesEl.appendChild(e);
  messagesEl.scrollTop=messagesEl.scrollHeight;
});

socket.on("userLeftEvent",(uid)=>{
  const e=document.createElement("div");
  e.className="event";
  e.textContent="ðŸ”´ "+uid+" left";
  messagesEl.appendChild(e);
  messagesEl.scrollTop=messagesEl.scrollHeight;
});

socket.on("pinnedNow",(text)=>{
  if(text){
    pinnedText.textContent=text;
    pinnedBar.style.display="block";
  }else{
    pinnedBar.style.display="none";
    pinnedText.textContent="";
  }
});

socket.on("clearChatNow",()=>{ messagesEl.innerHTML=""; });
socket.on("muteAllNow",()=>{ const e=document.createElement("div");e.className="event";e.textContent="ðŸ”‡ Admin muted all users";messagesEl.appendChild(e); });
socket.on("unmuteAllNow",()=>{ const e=document.createElement("div");e.className="event";e.textContent="ðŸ”Š Admin unmuted users";messagesEl.appendChild(e); });

clearBtn.onclick=()=>socket.emit("adminClearChat");
muteBtn.onclick=()=>socket.emit("adminMuteAll");
unmuteBtn.onclick=()=>socket.emit("adminUnmuteAll");

document.addEventListener("click",(ev)=>{
  if(!onlinePopup.contains(ev.target) && ev.target!==onlineCount)
    onlinePopup.style.display="none";
});
</script>

</body>
</html>
