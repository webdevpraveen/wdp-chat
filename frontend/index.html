<!DOCTYPE html>
<html>
<head>
    <title>WDP Live Chat</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{
            --bg:#f3f6f9;
            --panel:#ffffff;
            --self:#d1f7d8;
            --other:#e6f0ff;
            --admin:#ffe9ea;
            --muted:#8b97a6;
            --accent:#2b7cff;
            --text:#17202a;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{
            margin:0; background:var(--bg);
            font-family:Inter,Arial,Helvetica,sans-serif;
            display:flex; align-items:center; justify-content:center;
            height:100vh; color:var(--text);
        }
        .container{
            width:100%; max-width:980px; height:92vh;
            display:grid; grid-template-columns:1fr 320px;
            gap:20px; padding:20px;
        }
        .chat{
            background:var(--panel); border-radius:12px; display:flex;
            flex-direction:column; overflow:hidden; box-shadow:0 8px 30px rgba(15,22,30,0.06);
        }
        .header{
            padding:14px 18px; border-bottom:1px solid #eef2f5;
            display:flex; justify-content:space-between; align-items:center;
        }
        .title{ font-weight:700 }
        .controls{ display:flex; gap:10px; align-items:center }
        .controls button{ padding:8px 12px; border-radius:8px; border:1px solid #e6ecf5; background:#fff; cursor:pointer }
        .pinnedbar{
            background:#f7f8fa; padding:10px 16px; border-bottom:1px solid #eef2f5;
            display:flex; align-items:center; justify-content:space-between; font-size:14px;
        }
        .messages{
            flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:12px;
        }
        .info{ text-align:center; color:var(--muted); font-size:13px; margin-top:6px }
        .row{ display:flex; }
        .left{ justify-content:flex-start; }
        .right{ justify-content:flex-end; }
        .bubble{
            max-width:70%; padding:10px 14px; border-radius:12px; font-size:14px;
            box-shadow:0 2px 8px rgba(10,20,40,0.04);
        }
        .self{ background:var(--self); border-bottom-right:6px solid rgba(0,0,0,0.04) }
        .other{ background:var(--other) }
        .admin{ background:var(--admin); border-left:4px solid #ff6b6b; font-weight:600 }
        .meta{ font-size:12px; color:var(--muted); margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; align-items:center }
        .composer{ padding:12px; border-top:1px solid #eef2f5; display:flex; gap:10px; align-items:center }
        .composer input{ flex:1; padding:12px 14px; border-radius:999px; border:1px solid #e1e8f2; outline:none }
        .composer button{ padding:10px 14px; border-radius:999px; background:var(--accent); color:#fff; border:0; cursor:pointer; font-weight:600 }
        #typingStatus{ padding:6px 18px; color:var(--muted); min-height:18px }
        .side{
            background:var(--panel); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px; box-shadow:0 8px 30px rgba(15,22,30,0.06);
        }
        .side h4{ margin:0; font-size:14px }
        .online-list{ display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; padding-top:8px }
        .user-item{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #f0f5fb }
        .avatar{ width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:#e6eefc; color:#235; font-weight:700 }
        .emoji-btn{ cursor:pointer; font-size:20px; user-select:none; padding:6px; border-radius:8px; border:1px solid #eef4ff; background:#fff }
        .emoji-popup{ position:absolute; bottom:80px; right:30px; background:#fff; padding:10px; border-radius:10px; box-shadow:0 8px 30px rgba(20,30,40,0.08); display:none; width:220px; gap:8px; flex-wrap:wrap }
        .emoji-popup span{ font-size:20px; cursor:pointer }
        .pin-btn{ background:transparent; border:0; cursor:pointer; font-size:16px; color:var(--muted) }
        .small-muted{ font-size:12px; color:var(--muted) }
        .msg-actions{ display:flex; gap:6px; align-items:center }
        @media (max-width:980px){ .container{ grid-template-columns:1fr } .side{ order:2 } .chat{ order:1 } .emoji-popup{ right:16px } }
    </style>
</head>
<body>

<div class="container">

    <div class="chat">

        <div class="header">
            <div class="title">WDP Live Chat â€¢ <span id="onlineCount">0 online</span></div>
            <div class="controls">
                <div class="small-muted" id="youAs">You are: â€”</div>
                <div id="adminPanel"></div>
            </div>
        </div>

        <div id="pinnedBar" class="pinnedbar" style="display:none">
            <div style="display:flex; gap:10px; align-items:center"><div>ğŸ“Œ</div><div id="pinnedText"></div></div>
            <div><button id="unpinBtn" style="display:none">âŒ</button></div>
        </div>

        <div class="messages" id="messages"></div>
        <div id="typingStatus"></div>

        <div class="composer">
            <button class="emoji-btn" id="emojiBtn">ğŸ™‚</button>
            <input id="input" placeholder="Type a message..." />
            <button id="send">Send</button>
        </div>

    </div>

    <div class="side">
        <h4>Online</h4>
        <div class="online-list" id="onlineList"></div>
        <div style="height:1px;background:#eef2f7;margin:8px 0"></div>
        <div style="display:flex; gap:8px; align-items:center">
            <button id="clearChat" style="display:none">Clear</button>
            <button id="muteAll" style="display:none">Mute</button>
            <button id="unmuteAll" style="display:none">Unmute</button>
        </div>
    </div>

</div>

<div class="emoji-popup" id="emojiPopup">
    <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ˜</span><span>ğŸ¤£</span>
    <span>ğŸ˜­</span><span>ğŸ¤”</span><span>ğŸ˜¡</span><span>ğŸ¤©</span><span>â¤ï¸</span>
    <span>ğŸ”¥</span><span>ğŸ™</span><span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ‰</span>
</div>

<audio id="notifSound" src="notification.mp3" preload="auto"></audio>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const query = new URLSearchParams(window.location.search);
const isAdmin = query.get("admin") === "supersecret123";

const adminPanel = document.getElementById("adminPanel");
const clearChatBtn = document.getElementById("clearChat");
const muteAllBtn = document.getElementById("muteAll");
const unmuteAllBtn = document.getElementById("unmuteAll");

if (isAdmin) {
    adminPanel.innerHTML = '';
    clearChatBtn.style.display = 'inline-block';
    muteAllBtn.style.display = 'inline-block';
    unmuteAllBtn.style.display = 'inline-block';
}

let userId = localStorage.getItem("userId");
if (!userId) {
    userId = "User-" + Math.floor(10000 + Math.random() * 90000);
    localStorage.setItem("userId", userId);
}

document.getElementById("youAs").textContent = "You are: " + userId + (isAdmin ? " (admin)" : "");

const socket = io("https://wdp-chat.onrender.com");

socket.on("connect", () => {
    socket.emit("userConnected", userId);
});

const messages = document.getElementById("messages");
const typingStatus = document.getElementById("typingStatus");
const input = document.getElementById("input");
const notif = document.getElementById("notifSound");
const onlineList = document.getElementById("onlineList");
const pinnedBar = document.getElementById("pinnedBar");
const pinnedText = document.getElementById("pinnedText");
const unpinBtn = document.getElementById("unpinBtn");
const emojiBtn = document.getElementById("emojiBtn");
const emojiPopup = document.getElementById("emojiPopup");

let onlineUsersMap = {};

function scrollBottom(){ messages.scrollTop = messages.scrollHeight; }

function addEvent(text){
    const d = document.createElement("div");
    d.className = "event";
    d.textContent = text;
    messages.appendChild(d);
    scrollBottom();
}

function createPin(msgText){
    const btn = document.createElement("button");
    btn.className = "pin-btn";
    btn.title = "Pin (admin)";
    btn.textContent = "ğŸ“Œ";
    btn.onclick = ()=> socket.emit("pinMessage", msgText);
    return btn;
}

function renderMessage(msg){
    const row = document.createElement("div");
    row.className = "row " + (msg.userId === userId ? "right" : "left");

    const b = document.createElement("div");
    b.className = "bubble " + (msg.isAdmin ? "admin" : msg.userId === userId ? "self" : "other");

    const meta = document.createElement("div");
    meta.className = "meta";

    const leftName = document.createElement("div");
    leftName.textContent = msg.isAdmin ? "ğŸ‘‘ Admin ("+msg.userId+")" : (msg.userId === userId ? "You" : msg.userId);

    const time = document.createElement("div");
    time.className = "small-muted time";
    time.textContent = msg.timestamp || "";

    meta.appendChild(leftName);
    meta.appendChild(time);

    b.appendChild(meta);

    const body = document.createElement("div");
    body.textContent = msg.text;
    b.appendChild(body);

    const actions = document.createElement("div");
    actions.className = "msg-actions";

    if (isAdmin) {
        const pinBtn = createPin(msg.text);
        actions.appendChild(pinBtn);
    }

    meta.appendChild(actions);
    row.appendChild(b);
    messages.appendChild(row);
    scrollBottom();
}

document.getElementById("send").onclick = ()=>{
    const val = input.value.trim();
    if (!val) return;
    socket.emit("chatMessage",{ userId, text: val, isAdmin });
    input.value = "";
    socket.emit("stopTyping", userId);
};

input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") document.getElementById("send").click(); });

socket.on("chatMessage",(msg)=>{
    renderMessage(msg);
    if(msg.userId !== userId){ try{ notif.currentTime=0; notif.play(); }catch(e){} }
});

let typingTimer;
input.addEventListener("input",()=>{
    socket.emit("typing", userId);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=> socket.emit("stopTyping", userId),600);
});

socket.on("userTyping",(uid)=>{ if(uid!==userId) typingStatus.textContent = uid + " is typing..."; });
socket.on("userStopTyping",()=> typingStatus.textContent = "");

socket.on("userJoined",(uid)=>{
    addEvent("ğŸŸ¢ "+uid+" joined");
    onlineUsersMap[uid]=true;
    renderOnline();
});
socket.on("userLeft",(uid)=>{
    addEvent("ğŸ”´ "+uid+" left");
    delete onlineUsersMap[uid];
    renderOnline();
});

socket.on("onlineCount",(n)=> document.getElementById("onlineCount").textContent = n + " online");
socket.on("clearChatNow",()=> messages.innerHTML = "");
socket.on("muteAllNow",()=> addEvent("ğŸ”‡ Admin muted all users"));
socket.on("unmuteAllNow",()=> addEvent("ğŸ”Š Admin unmuted users"));

if(isAdmin){
    clearChatBtn.onclick = ()=> socket.emit("adminClearChat");
    muteAllBtn.onclick = ()=> socket.emit("adminMuteAll");
    unmuteAllBtn.onclick = ()=> socket.emit("adminUnmuteAll");
}

socket.on("pinnedNow",(text)=>{
    if(text && text.length){
        pinnedText.textContent = text;
        pinnedBar.style.display = "flex";
        unpinBtn.style.display = isAdmin ? "inline-block" : "none";
    } else {
        pinnedBar.style.display = "none";
        pinnedText.textContent = "";
        unpinBtn.style.display = "none";
    }
});

unpinBtn.onclick = ()=> socket.emit("unpinMessage");

emojiBtn.onclick = ()=> emojiPopup.style.display = emojiPopup.style.display === "flex" ? "none" : "flex";

emojiPopup.querySelectorAll("span").forEach(em=>{
    em.onclick = ()=>{
        input.value += em.textContent;
        emojiPopup.style.display = "none";
        input.focus();
    };
});

document.addEventListener("click",(e)=>{
    if(!emojiPopup.contains(e.target) && e.target !== emojiBtn) emojiPopup.style.display="none";
});

function renderOnline(){
    onlineList.innerHTML = "";
    const keys = Object.keys(onlineUsersMap);
    keys.forEach(k=>{
        const item = document.createElement("div");
        item.className = "user-item";
        const av = document.createElement("div");
        av.className = "avatar";
        av.textContent = k.replace(/[^A-Za-z0-9]/g,'').slice(0,2);
        const name = document.createElement("div");
        name.textContent = k;
        item.appendChild(av);
        item.appendChild(name);
        onlineList.appendChild(item);
    });
}

addEvent("You are: "+userId + (isAdmin ? " (admin)" : ""));
</script>

</body>
</html>
