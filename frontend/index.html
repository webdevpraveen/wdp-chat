<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SRMU Web Chat</title>
<style>
:root{
  --bg:#f1f4f8; --panel:#ffffff;
  --self:#d8f8d2; --other:#e6f0ff;
  --admin:#ffe6e6; --welcome:#fff7cc;
  --accent:#2b7cff; --muted:#6b7280;
  --text:#111827; --radius:12px;
  --tick-gray:#9aa3b2; --tick-blue:#0b93f6;
}
*{ box-sizing:border-box; }
body{ margin:0; background:var(--bg); font-family:Inter,Arial; display:flex; justify-content:center; align-items:center; height:100vh; color:var(--text); }
.chat{ width:100%; max-width:980px; height:92vh; background:var(--panel); border-radius:12px; box-shadow:0 12px 30px rgba(25,35,45,0.08); display:flex; flex-direction:column; overflow:hidden; }

/* header & popup (same as before) */
.header{ padding:10px 16px; border-bottom:1px solid #e5eaf0; background:#fff; }
.header-row{ display:flex; justify-content:space-between; align-items:center; width:100%; }
.online-box{ padding:6px 12px; background:#fff; border:1px solid #e5eaf0; border-radius:10px; font-weight:600; cursor:pointer; white-space:nowrap; }
.title-wrap{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.app-title{ font-size:20px; font-weight:700; }
.you-are{ font-size:13px; color:#6b7280; margin-top:2px; }
.right-wrap{ display:flex; gap:12px; align-items:center; }
.about-btn{ padding:6px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:13px; }
.github-icon{ width:36px; height:36px; border-radius:50%; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center; }

/* popup */
.popup{ position:absolute; right:16px; top:95px; width:260px; background:#fff; border-radius:10px; box-shadow:0 12px 40px rgba(0,0,0,0.15); display:none; z-index:50; }
.popup-header{ padding:10px 12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
.close-btn{ cursor:pointer; font-size:18px; }
.popup-list div{ padding:8px 12px; border-bottom:1px solid #f5f5f5; display:flex; justify-content:space-between; align-items:center; gap:8px; }
.msg-button{ padding:6px 8px; border-radius:6px; border:1px solid #e6eef6; background:#fff; cursor:pointer; font-size:13px; }

/* admin panel */
.admin-panel{ padding:10px; display:none; gap:8px; border-bottom:1px solid #e5eaf0; }
.admin-panel button{ padding:6px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:13px; }

/* messages */
.messages{ flex:1; padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px; }
.event{ text-align:center; font-size:13px; color:var(--muted); }
.msg-row{ display:flex; }
.left{ justify-content:flex-start; }
.right{ justify-content:flex-end; }

/* bubble */
.bubble{ max-width:75%; padding:10px 14px; border-radius:var(--radius); font-size:14px; box-shadow:0 4px 16px rgba(0,0,0,0.06); }
.self{ background:var(--self); }
.other{ background:var(--other); }
.admin{ background:var(--admin); border-left:4px solid #ff6b6b; }
.welcome{ background:var(--welcome); }
.dm{ border:2px dashed rgba(120,80,200,0.12); }

/* meta */
.meta{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:12px; }
.meta-name{ margin-right:8px; font-weight:600; }
.meta-time{ color:var(--muted); }

/* ticks area */
.tick{ margin-left:8px; font-size:14px; color:var(--tick-gray); display:inline-block; min-width:20px; text-align:right; }
.tick.seen{ color:var(--tick-blue); }

/* typing */
.typing{ height:18px; padding-left:16px; color:var(--muted); }

/* composer */
.composer{ padding:10px 14px; display:flex; align-items:center; gap:10px; border-top:1px solid #e5eaf0; background:#fafbfd; }
.composer input{ flex:1; padding:12px 16px; border-radius:14px; border:1px solid #cfd6df; background:#fff; font-size:15px; transition:0.2s; }
.composer input:focus{ border-color:#a7b3c2; box-shadow:0 0 0 2px rgba(43,124,255,0.15); outline:none; }
.composer button{ background:var(--accent); padding:10px 20px; border:none; border-radius:14px; font-weight:600; color:#fff; cursor:pointer; transition:0.2s; }
.composer button:hover{ opacity:0.85; }

/* emoji */
.emoji-btn{ width:44px; height:44px; border-radius:14px; background:#fff; border:1px solid #d7dce3; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:22px; transition:0.2s; }
.emoji-btn:hover{ background:#f0f2f5; }
.emoji-popup{ position:absolute; bottom:90px; left:20px; background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px; display:none; box-shadow:0 10px 30px rgba(0,0,0,0.15); }
.emoji-popup span{ font-size:24px; padding:6px; display:inline-block; cursor:pointer; }

#dmHolder{ display:none; align-items:center; }
.dm-tag{ padding:6px 12px; background:#f3e8ff; border-radius:10px; border:1px solid #e8d7ff; font-weight:600; }
.cancel-dm{ margin-left:8px; color:#d54949; cursor:pointer; font-weight:700; }

@media(max-width:700px){ .app-title{ font-size:18px; } .popup{ right:10px; top:92px; width:220px; } .emoji-popup{ left:12px; bottom:84px; } }
</style>
</head>
<body>

<div class="chat">
  <div class="header">
    <div class="header-row">
      <div id="onlineBox" class="online-box">0 online</div>

      <div class="title-wrap">
        <div class="app-title">SRMU Web Chat</div>
        <div id="youAre" class="you-are"></div>
      </div>

      <div class="right-wrap">
        <button id="aboutBtn" class="about-btn">About</button>
        <a href="https://github.com/webdevpraveen" target="_blank" class="github-icon">
          <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8a8 8 0 005.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.65 7.65 0 012 0c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8 8 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
        </a>
      </div>
    </div>
  </div>

  <div id="popup" class="popup">
    <div class="popup-header">Online Users<div id="closePopup" class="close-btn">√ó</div></div>
    <div id="popupList" class="popup-list"></div>
  </div>

  <div id="adminPanel" class="admin-panel">
    <button id="clearChat">Clear</button>
    <button id="muteAll">Mute</button>
    <button id="unmuteAll">Unmute</button>
  </div>

  <div id="messages" class="messages"></div>
  <div id="typing" class="typing"></div>

  <div class="composer">
    <div id="emojiBtn" class="emoji-btn">üòä</div>
    <div id="emojiPopup" class="emoji-popup">
      <span>üòÄ</span><span>üòÅ</span><span>üòÇ</span><span>ü§£</span>
      <span>üòç</span><span>üòé</span><span>üò≠</span><span>üëÄ</span>
      <span>ü§î</span><span>üëç</span><span>üëé</span><span>üëã</span>
    </div>

    <div id="dmHolder"><span id="dmTag" class="dm-tag"></span><span id="dmCancel" class="cancel-dm">‚úñ</span></div>

    <input id="input" placeholder="Type your message..." autocomplete="off" />
    <button id="send">Send</button>
  </div>
</div>

<audio id="notif" src="notification.mp3" preload="auto"></audio>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io("https://wdp-chat.onrender.com");

let userId = localStorage.getItem("uid");
if(!userId){
  userId = "User-" + Math.floor(10000 + Math.random()*90000);
  localStorage.setItem("uid",userId);
}
document.getElementById("youAre").textContent = "You are: " + userId;

const messages=document.getElementById("messages");
const typing=document.getElementById("typing");
const popup=document.getElementById("popup");
const popupList=document.getElementById("popupList");
const notif=document.getElementById("notif");
const dmHolder=document.getElementById("dmHolder");
const dmTag=document.getElementById("dmTag");
const dmCancel=document.getElementById("dmCancel");

let dmTarget = null;
const nameColors = {};
const pastel=["#8e7dff","#ff7dcf","#ffb877","#77baff","#74d39c","#ff8f8f","#b785ff","#8fd1ff"];
function nameColor(uid){ if(nameColors[uid]) return nameColors[uid]; return nameColors[uid]=pastel[Math.floor(Math.random()*pastel.length)]; }

let soundReady=false;
function ready(){ if(soundReady) return; notif.play().then(()=>{notif.pause();notif.currentTime=0;soundReady=true;}); }
window.addEventListener("click",ready);

const params=new URLSearchParams(location.search);
const isAdmin=params.get("admin")==="supersecret123";
if(isAdmin) document.getElementById("adminPanel").style.display="flex";

socket.emit("userConnected",userId);

function makeId(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2,7);
}

const messageNodes = {}; // msgId -> DOM element for tick updates

document.getElementById("send").onclick = ()=>{
  const t = input.value.trim();
  if(!t) return;

  if(dmTarget){
    const id = makeId();
    const data = { id, from: userId, to: dmTarget, text: t };
    addMsg({ id, from: userId, to: dmTarget, text: t, timestamp: new Date().toLocaleTimeString(), isDM: true, userSent: true });
    socket.emit("privateMessage", data);
  } else {
    const msg = { userId, text: t };
    socket.emit("chatMessage", msg);
  }

  input.value="";
  socket.emit("stopTyping", userId);
};

input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") document.getElementById("send").click(); });

let timer;
input.addEventListener("input",()=>{
  socket.emit("typing",userId);
  clearTimeout(timer);
  timer = setTimeout(()=>socket.emit("stopTyping",userId),500);
});

function createTickSpan(id){
  const s = document.createElement("span");
  s.className = "tick";
  s.dataset.msgid = id;
  s.textContent = ""; // no tick initially
  return s;
}

function setDelivered(id){
  const el = messageNodes[id];
  if(!el) return;
  const tick = el.querySelector(".tick");
  if(tick) tick.textContent = "‚úì";
  tick.classList.remove("seen");
  tick.style.color = "var(--tick-gray)";
}

function setSeen(id){
  const el = messageNodes[id];
  if(!el) return;
  const tick = el.querySelector(".tick");
  if(tick) { tick.textContent = "‚úì‚úì"; tick.classList.add("seen"); tick.style.color = "var(--tick-blue)"; }
}

function addMsg(m){
  const row = document.createElement("div");
  row.className = "msg-row " + (((m.userId===userId) || (m.from && m.from===userId) || m.userSent) ? "right" : "left");

  const b = document.createElement("div");
  b.className = "bubble";

  if(m.isWelcome) b.classList.add("welcome");
  else if(m.isAdmin) b.classList.add("admin");
  else if(m.isDM || m.to) b.classList.add("dm");
  else if(m.userId===userId) b.classList.add("self");
  else b.classList.add("other");

  const meta = document.createElement("div");
  meta.className = "meta";

  const name = document.createElement("div");
  name.className = "meta-name";
  name.textContent = m.from ? (m.from===userId ? "You" : m.from) : (m.userId===userId ? "You" : m.userId);
  if(name.textContent !== "You") name.style.color = nameColor(name.textContent);

  const tim = document.createElement("div");
  tim.className = "meta-time";
  tim.textContent = m.timestamp || "";

  meta.appendChild(name);
  meta.appendChild(tim);

  const body = document.createElement("div");
  if(m.isDM){
    const note = document.createElement("div");
    note.style.fontSize = "12px"; note.style.color = "var(--muted)"; note.style.marginBottom = "6px";
    note.textContent = m.from === userId ? "(Private to "+m.to+")" : "(Private from "+m.from+")";
    body.appendChild(note);
  }

  const txt = document.createElement("div");
  txt.textContent = m.text;
  body.appendChild(txt);

  b.appendChild(meta);
  b.appendChild(body);

  if(m.isDM && (m.from===userId || m.userSent)){
    const tick = createTickSpan(m.id);
    b.appendChild(tick);
    // store node for later updates
    messageNodes[m.id] = b;
  }

  row.appendChild(b);
  messages.appendChild(row);
  messages.scrollTop = messages.scrollHeight;

  // attempt to auto-send seen if DM received and window focused
  if(m.isDM && m.to === userId){
    // recipient viewing the DM message
    if(document.hasFocus()){
      socket.emit("dmSeen", { id: m.id, from: m.from, to: m.to });
    }
  }

  // play sound for non-DM messages from others
  if(((m.userId && m.userId!==userId) || (m.from && m.from!==userId)) && !m.isDM && soundReady){
    notif.currentTime = 0; notif.play();
  }
}

socket.on("chatMessage", (m) => addMsg(m));

socket.on("privateMessage", (m, ack) => {
  // acknowledge delivery to server
  try { if(typeof ack === "function") ack(true); } catch(e){}
  addMsg(m);
});

socket.on("dmDelivered", (data) => {
  // sender gets delivered confirmation
  setDelivered(data.id);
});

socket.on("dmSeenUpdate", (data) => {
  // both sides get seen update
  setSeen(data.id);
});

socket.on("userTyping", (uid) => { if(uid!==userId) typing.textContent = uid + " is typing..."; });
socket.on("userStopTyping", () => typing.textContent = "");

/* online popup */
document.getElementById("onlineBox").onclick = ()=> popup.style.display = "block";
document.getElementById("closePopup").onclick = ()=> popup.style.display = "none";

socket.on("onlineList", (list) => {
  onlineBox.textContent = list.length + " online";
  popupList.innerHTML = "";
  list.forEach(u=>{
    const d = document.createElement("div");
    d.textContent = u;
    const btn = document.createElement("button");
    btn.className = "msg-button";
    btn.textContent = "Message";
    btn.onclick = ()=>{
      if(u === userId) return alert("You can't DM yourself");
      dmTarget = u;
      dmTag.textContent = "DM ‚Üí " + u;
      dmHolder.style.display = "flex";
      input.focus();
    };
    d.appendChild(btn);
    popupList.appendChild(d);
  });
});

/* Cancel DM manually */
dmCancel.onclick = ()=> { dmTarget = null; dmHolder.style.display = "none"; };

/* admin */
clearChat.onclick = ()=> socket.emit("adminClearChat");
muteAll.onclick = ()=> socket.emit("adminMuteAll");
unmuteAll.onclick = ()=> socket.emit("adminUnmuteAll");

socket.on("clearChatNow", ()=> messages.innerHTML = "" );
socket.on("muteAllNow", ()=> { const e=document.createElement("div"); e.className="event"; e.textContent="üîá Admin muted all users"; messages.appendChild(e); });
socket.on("unmuteAllNow", ()=> { const e=document.createElement("div"); e.className="event"; e.textContent="üîä Admin unmuted users"; messages.appendChild(e); });

/* emoji popup */
document.getElementById("emojiBtn").onclick = ()=> { emojiPopup.style.display = emojiPopup.style.display==="block" ? "none" : "block"; };
document.getElementById("emojiPopup").onclick = (e)=> { if(e.target.tagName==="SPAN"){ input.value += e.target.textContent; emojiPopup.style.display="none"; input.focus(); } };

/* when window gains focus: request seen for visible DM messages */
window.addEventListener("focus", ()=> {
  // find all visible DM messages where from !== userId and not yet seen (we can't track seen state persistently here, so best-effort: notify server for recent DMs)
  // We'll emit dmSeen for any last DM received in DOM
  const dmElems = Array.from(document.querySelectorAll(".bubble"));
  for(let i=dmElems.length-1;i>=0;i--){
    const el = dmElems[i];
    if(el.classList.contains("dm")){
      const tick = el.querySelector(".tick");
      // if no tick or single tick but message belongs to other user -> send dmSeen
      const metaName = el.querySelector(".meta-name");
      const nameText = metaName ? metaName.textContent : "";
      // get msg id from stored nodes map by searching
      const id = Object.keys(messageNodes).find(k => messageNodes[k] === el);
      if(id){
        // get first child note to see from/to
        const note = el.querySelector("div > div");
        // if note exists and indicates private from someone else, inform seen
        // best-effort: just send dmSeen to server for this id
        socket.emit("dmSeen", { id, from: (el.dataset && el.dataset.from) || null, to: userId });
        break;
      }
    }
  }
});
</script>
</body>
</html>
