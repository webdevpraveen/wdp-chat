<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SRMU Web Chat</title>
<style>
:root{
  --bg:#f1f4f8; --panel:#fff;
  --self:#d8f8d2; --other:#e6f0ff; --admin:#ffe6e6; --welcome:#fff7cc;
  --accent:#2b7cff; --muted:#6b7280; --radius:12px;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);
  font-family:Inter,Arial;
  display:flex;justify-content:center;align-items:center;
  height:100vh;color:#111;
}
.chat{
  width:100%;max-width:980px;height:92vh;background:var(--panel);
  border-radius:12px;box-shadow:0 12px 30px rgba(25,35,45,0.08);
  display:flex;flex-direction:column;overflow:hidden;
}
.header{padding:12px 16px;border-bottom:1px solid #e5eaf0;background:#fff;}
.header-row{display:flex;justify-content:space-between;align-items:center}
.online-box{padding:6px 12px;background:#fff;border:1px solid #e5eaf0;border-radius:10px;font-weight:600;cursor:pointer;}
.title-center{text-align:center;display:flex;flex-direction:column;align-items:center;}
.app-title{font-size:20px;font-weight:700}
.you-are{font-size:13px;color:#6b7280;margin-top:2px}
.right-wrap{display:flex;gap:12px;align-items:center}
.about-btn{padding:6px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:13px;}
.popup{position:absolute;right:16px;top:95px;width:320px;background:#fff;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.15);display:none;z-index:50;}
.popup-header{padding:10px 12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;font-weight:600;}
.close-btn{cursor:pointer;font-size:18px;}
.popup-list div{padding:8px 12px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center;gap:8px}
.msg-button{padding:6px 8px;border-radius:6px;border:1px solid #e6eef6;background:#fff;cursor:pointer;font-size:13px;}
.admin-panel{padding:10px;display:none;gap:8px;border-bottom:1px solid #e5eaf0;}
.admin-panel button{padding:6px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:13px;}
.messages{
  flex:1;
  padding:18px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  background-image: url('assests/chat-bg.png');
  background-size: cover;
  background-position: center;
  background-repeat: repeat;
}

.event{text-align:center;font-size:13px;color:var(--muted);}
.msg-row{display:flex;}
.left{justify-content:flex-start;}
.right{justify-content:flex-end;}
.bubble{max-width:75%;padding:10px 14px;border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,0.06); backdrop-filter: blur(2px);}
.self{background:var(--self);}
.other{background:var(--other);}
.admin{background:var(--admin);border-left:4px solid #ff6b6b;}
.welcome{background:var(--welcome);}
.dm{border:2px dashed rgba(120,80,200,0.12);}
.meta{display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px;}
.meta-name{font-weight:600;}
.meta-time{color:var(--muted);}
.typing{height:18px;padding-left:16px;color:var(--muted)}
.composer{padding:10px 14px;display:flex;align-items:center;gap:10px;border-top:1px solid #e5eaf0;background:#fafbfd;}
.composer input{flex:1;padding:12px 16px;border-radius:14px;border:1px solid #cfd6df;background:#fff;font-size:15px;}
.composer button{background:var(--accent);padding:10px 20px;border:none;border-radius:14px;font-weight:600;color:#fff;cursor:pointer;}
.emoji-btn{width:44px;height:44px;border-radius:14px;background:#fff;border:1px solid #d7dce3;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;}
.emoji-popup{position:absolute;bottom:90px;left:20px;background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px;display:none;}
.emoji-popup span{font-size:24px;padding:6px;cursor:pointer}
#dmHolder{display:none;align-items:center}
.dm-tag{padding:6px 12px;background:#f3e8ff;border-radius:10px;border:1px solid #e8d7ff;font-weight:600;}
.cancel-dm{margin-left:8px;color:#d54949;cursor:pointer;font-weight:700;}
.invite-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:10px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,0.25);z-index:200;display:none;width:320px;}
.invite-header{font-weight:700;margin-bottom:8px;}
.invite-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
.invite-btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
.invite-accept{background:#2b7cff;color:#fff;border:none}
.admin-dashboard{position:fixed;left:16px;top:110px;width:420px;height:60vh;background:#fff;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.12);padding:12px;overflow:auto;display:none;z-index:80;}
.admin-dashboard h4{margin:6px 0 10px 0;}
.dm-list-item{padding:8px;border-bottom:1px solid #f3f3f3;display:flex;justify-content:space-between;align-items:center;}
.dm-view{padding:10px;border-radius:8px;background:#fbfbfe;height:60vh;overflow:auto;display:none;}
.reaction-popup{position:absolute;background:#fff;padding:6px 10px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);display:none;gap:8px;z-index:80;font-size:22px;}
.reaction-popup span{cursor:pointer;}
.reaction-bar{display:flex;gap:6px;margin-top:6px;}
.reaction-chip{padding:2px 6px;background:#f0f2f5;border-radius:8px;font-size:13px;}
@media(max-width:900px){.admin-dashboard{display:none!important}}
.online-user {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.online-dot {
  width: 10px;
  height: 10px;
  background: #22c55e; /* green */
  border-radius: 50%;
  box-shadow: 0 0 4px rgba(34,197,94,0.7);
}

.ping-box {
  position: fixed;
  bottom: 12px;
  right: 15px;
  background: rgba(0, 0, 0, 0.6);
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  color: #ffffff;
  z-index: 9999;
  transition: background 0.3s ease;
}

</style>
</head>
<body>

<div id="reactionPopup" class="reaction-popup">
  <span data-r="üëç">üëç</span><span data-r="‚ù§Ô∏è">‚ù§Ô∏è</span><span data-r="üòÇ">üòÇ</span>
  <span data-r="üòÆ">üòÆ</span><span data-r="üò¢">üò¢</span><span data-r="üò°">üò°</span>
</div>

<div id="inviteModal" class="invite-modal">
  <div class="invite-header" id="inviteText">User invited you</div>
  <div id="inviteMeta" style="color:var(--muted);font-size:13px"></div>
  <div class="invite-actions">
    <button id="inviteDecline" class="invite-btn">Cancel</button>
    <button id="inviteAccept" class="invite-btn invite-accept">Join</button>
  </div>
</div>

<div class="chat">
  <div class="header">
    <div class="header-row">
      <div id="onlineBox" class="online-box">0 online</div>
      <div class="title-center">
        <div class="app-title">SRMU Web Chat</div>
        <div id="youAre" class="you-are"></div>
      </div>
      <div class="right-wrap">
        <a href="./about.html" class="about-btn">About</a>
      </div>
    </div>
  </div>

  <div id="popup" class="popup">
    <div class="popup-header">
      Online Users <div id="closePopup" class="close-btn">√ó</div>
    </div>
    <div id="popupList" class="popup-list"></div>
  </div>

  <div id="adminPanel" class="admin-panel">
    <button id="clearChat">Clear</button>
    <button id="muteAll">Mute</button>
    <button id="unmuteAll">Unmute</button>
    <button id="openAdminDash">Admin Dashboard</button>
  </div>

  <div id="messages" class="messages"></div>
  <div id="typing" class="typing"></div>

  <div class="composer">
    <div id="emojiBtn" class="emoji-btn">üòä</div>
    <div id="emojiPopup" class="emoji-popup">
      <span>üòÄ</span><span>üòÅ</span><span>üòÇ</span><span>ü§£</span>
      <span>üòç</span><span>üòé</span><span>üò≠</span><span>üëÄ</span>
      <span>ü§î</span><span>üëç</span><span>üëé</span><span>üëã</span>
    </div>

    <div id="dmHolder">
      <span id="dmTag" class="dm-tag"></span>
      <span id="dmCancel" class="cancel-dm">‚úñ</span>
    </div>

    <input id="input" placeholder="Type your message..." autocomplete="off" />
    <button id="send">Send</button>
  </div>
</div>

<div id="adminDashboard" class="admin-dashboard">
  <h4>Admin Dashboard</h4>
  <div><strong>Online users</strong></div>
  <div id="adminOnline"></div>
  <hr/>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div><strong>DM Logs (last 60m)</strong></div>
    <button id="refreshDmLogs" class="invite-btn">Refresh</button>
  </div>
  <div id="dmList"></div>
  <hr/>
  <div id="dmViewer" class="dm-view"></div>
</div>

<audio id="notif" src="assests/notification.mp3" preload="auto"></audio>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const socket = io("https://wdp-chat.onrender.com", {
  transports: ["websocket","polling"],
  path: "/socket.io",
  withCredentials: false
});

socket.on("connect", () => {
  console.log("[SOCKET] connected", socket.id);

  const pingBox = document.getElementById("ping");
  if (!pingBox) return;

  let lastPing = Date.now();

  socket.io.engine.on("pong", () => {
    const ping = Date.now() - lastPing;
    pingBox.innerText = `üì∂ Ping: ${ping} ms`;

    if (ping <= 80) {
      pingBox.style.background = "#22c55e"; // green
    } else if (ping <= 150) {
      pingBox.style.background = "#facc15"; // yellow
    } else {
      pingBox.style.background = "#ef4444"; // red
    }
  });

  setInterval(() => {
    if (socket.connected) {
      lastPing = Date.now();
      socket.io.engine.ping();
    }
  }, 2000);
});

socket.on("connect_error", e=>console.error("[SOCKET ERROR]", e));
socket.on("disconnect", ()=>console.log("[SOCKET] disconnected"));

let userId = localStorage.getItem("uid");
if(!userId){ userId = "User-" + Math.floor(10000 + Math.random()*90000); localStorage.setItem("uid", userId); }
document.getElementById("youAre").textContent = "You are: " + userId;

const params = new URLSearchParams(location.search);
const isAdmin = params.get("admin") === "getelementwebdevpraveenapi:19122006";
if(isAdmin){ document.getElementById("adminPanel").style.display = "flex"; socket.emit("registerAdmin"); }

socket.emit("userConnected", userId);

const messages = document.getElementById("messages");
const typing = document.getElementById("typing");
const popup = document.getElementById("popup");
const popupList = document.getElementById("popupList");
const notif = document.getElementById("notif");
const dmHolder = document.getElementById("dmHolder");
const dmTag = document.getElementById("dmTag");
const dmCancel = document.getElementById("dmCancel");
const adminPanel = document.getElementById("adminPanel");
const adminDashboard = document.getElementById("adminDashboard");
const adminOnline = document.getElementById("adminOnline");
const dmList = document.getElementById("dmList");
const dmViewer = document.getElementById("dmViewer");
let dmTarget = null;
let pendingInvite = null;
const nameColors = {};
const pastel = ["#8e7dff","#ff7dcf","#ffb877","#77baff","#74d39c","#ff8f8f","#b785ff","#8fd1ff"];
function nameColor(uid){ if(nameColors[uid]) return nameColors[uid]; return nameColors[uid]=pastel[Math.floor(Math.random()*pastel.length)]; }
let soundReady=false;
window.addEventListener("click", ()=>{ if(!soundReady){ notif.play().then(()=>{ notif.pause(); notif.currentTime=0; soundReady=true; }).catch(()=>{}); }});

function scrollBottom(){ messages.scrollTop = messages.scrollHeight; }
function showEvent(text, ttl=3500){ const d=document.createElement("div"); d.className="event"; d.textContent=text; messages.appendChild(d); scrollBottom(); if(ttl) setTimeout(()=>{ if(d.parentNode) d.parentNode.removeChild(d); }, ttl); }

function createBubble(msg){
  const row = document.createElement("div");
  row.className = "msg-row " + ((msg.userId===userId || (msg.from && msg.from===userId)) ? "right" : "left");
  const b = document.createElement("div"); b.className = "bubble";
  if(msg.isWelcome) b.classList.add("welcome");
  else if(msg.isAdmin) b.classList.add("admin");
  else if(msg.isDM) b.classList.add("dm");
  else if(msg.userId===userId) b.classList.add("self");
  else b.classList.add("other");

  const meta = document.createElement("div"); meta.className = "meta";
  const name = document.createElement("div"); name.className = "meta-name";
  name.textContent = msg.from ? (msg.from===userId ? "You" : msg.from) : (msg.userId===userId ? "You" : msg.userId);
  if(name.textContent !== "You") name.style.color = nameColor(name.textContent);
  const time = document.createElement("div"); time.className = "meta-time"; time.textContent = msg.timestamp || "";
  meta.appendChild(name); meta.appendChild(time);

  const body = document.createElement("div");
  if(msg.isDM){
    const note = document.createElement("div"); note.style.fontSize="12px"; note.style.color="var(--muted)"; note.style.marginBottom="6px";
    note.textContent = msg.from===userId ? "(Private to "+msg.to+")" : "(Private from "+msg.from+")";
    body.appendChild(note);
  }
  const txt = document.createElement("div"); txt.textContent = msg.text; body.appendChild(txt);
  b.appendChild(meta); b.appendChild(body);
  row.appendChild(b);
  messages.appendChild(row);
  scrollBottom();
  if((msg.userId && msg.userId !== userId) || (msg.from && msg.from !== userId)){
    if(!msg.isDM && soundReady){ try{ notif.currentTime = 0; notif.play(); }catch(e){} }
  }
  b.style.position="relative";
  const reactBar = document.createElement("div"); reactBar.className="reaction-bar"; b.appendChild(reactBar);
  msg._reactions = {};
  function updateReactions(){ reactBar.innerHTML=""; for(let emo in msg._reactions){ const cnt = msg._reactions[emo].size; if(cnt>0){ const chip=document.createElement("div"); chip.className="reaction-chip"; chip.textContent = emo + " " + cnt; reactBar.appendChild(chip); } } }
  function toggleReaction(uid, emo){ if(!msg._reactions[emo]) msg._reactions[emo]=new Set(); if(msg._reactions[emo].has(uid)) msg._reactions[emo].delete(uid); else msg._reactions[emo].add(uid); updateReactions(); }
  b.oncontextmenu = e => { e.preventDefault(); openReactionPopup(e, msg, toggleReaction); };
  b.onclick = e => { if(e.shiftKey) openReactionPopup(e, msg, toggleReaction); };
  return b;
}

socket.on("loadHistory", arr => {
  messages.innerHTML = "";
  arr.forEach(m => {
    createBubble({ userId:m.userId, text:m.text, timestamp:m.timestamp, isAdmin:m.isAdmin });
  });
});

socket.on("chatMessage", m => { createBubble(m); });

socket.on("privateMessage", m => { createBubble(m); });

socket.on("userTyping", uid => { if(uid !== userId) typing.textContent = uid + " is typing..."; });
socket.on("userStopTyping", () => typing.textContent = "");

socket.on("userJoinedEvent", uid => { showEvent("üü¢ "+uid+" joined"); });
socket.on("userLeftEvent", uid => { showEvent("üî¥ "+uid+" left"); });

socket.on("onlineList", list => {
  document.getElementById("onlineBox").textContent = list.length + " online";
  popupList.innerHTML = "";

  list.forEach(u => {
    const row = document.createElement("div");
    row.className = "online-user";

    const nameWrap = document.createElement("div");
    nameWrap.style.display = "flex";
    nameWrap.style.alignItems = "center";
    nameWrap.style.gap = "8px";

    const dot = document.createElement("span");
    dot.className = "online-dot";

    const name = document.createElement("span");
    name.textContent = u;

    nameWrap.appendChild(dot);
    nameWrap.appendChild(name);

    const btn = document.createElement("button");
    btn.className = "msg-button";
    btn.textContent = "Message";
    btn.onclick = () => {
      if (u === userId) return alert("You can't DM yourself");
      socket.emit("dmInvite", { from: userId, to: u });
      showEvent("Invite sent to " + u);
    };

    row.appendChild(nameWrap);
    row.appendChild(btn);
    popupList.appendChild(row);
  });
});


function openReactionPopup(e, message, toggleFn){
  const pop = document.getElementById("reactionPopup");
  pop.style.left = (e.pageX - 60) + "px";
  pop.style.top = (e.pageY - 50) + "px";
  pop.style.display = "flex";
  [...pop.children].forEach(sp => { sp.onclick = () => { toggleFn(userId, sp.dataset.r); pop.style.display = "none"; }; });
  setTimeout(()=>{ document.body.onclick = ev => { if(!pop.contains(ev.target)) pop.style.display = "none"; }; },10);
}

let typingTimer;
document.getElementById("input").addEventListener("input", () => {
  socket.emit("typing", userId);
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=> socket.emit("stopTyping", userId), 600);
});

document.getElementById("send").onclick = () => {
  const val = document.getElementById("input").value.trim();
  if(!val) return;
  if(dmTarget){ socket.emit("privateMessage", { from:userId, to:dmTarget, text: val }); dmHolder.style.display="none"; dmTarget=null; }
  else { socket.emit("chatMessage", { userId, text: val, isAdmin: isAdmin }); }
  document.getElementById("input").value = "";
  socket.emit("stopTyping", userId);
};
document.getElementById("input").addEventListener("keydown", e => { if(e.key === "Enter") document.getElementById("send").click(); });

document.getElementById("emojiBtn").onclick = ()=>{ const ep=document.getElementById("emojiPopup"); ep.style.display = ep.style.display==="block" ? "none" : "block"; };
document.getElementById("emojiPopup").addEventListener("click", e => { if(e.target.tagName==="SPAN"){ document.getElementById("input").value += e.target.textContent; document.getElementById("emojiPopup").style.display="none"; document.getElementById("input").focus(); } });

socket.on("dmInviteSent", info => showEvent("Invite sent ("+info.to+")"));
socket.on("dmInviteFailed", info => alert("Invite failed: "+(info.reason||"unknown")));
socket.on("incomingDmInvite", data => { pendingInvite = data; document.getElementById("inviteText").textContent = data.from + " invited you to a private chat"; document.getElementById("inviteMeta").textContent = "Private chat room will open if you join."; document.getElementById("inviteModal").style.display = "block"; });
document.getElementById("inviteAccept").onclick = ()=>{ if(!pendingInvite) return; socket.emit("dmInviteResponse",{ from:pendingInvite.from, to:pendingInvite.to, roomId:pendingInvite.roomId, accept:true }); document.getElementById("inviteModal").style.display="none"; pendingInvite=null; };
document.getElementById("inviteDecline").onclick = ()=>{ if(!pendingInvite) return; socket.emit("dmInviteResponse",{ from:pendingInvite.from, to:pendingInvite.to, roomId:pendingInvite.roomId, accept:false }); document.getElementById("inviteModal").style.display="none"; pendingInvite=null; };

socket.on("dmInviteAccepted", info => { const roomUrl = location.origin + "/dm.html?room=" + encodeURIComponent(info.roomId) + "&a=" + encodeURIComponent(info.from) + "&b=" + encodeURIComponent(info.to); window.open(roomUrl,'_blank'); showEvent("Private chat opened"); });
socket.on("dmInviteDeclined", info => showEvent(info.to + " declined the invite"));

document.getElementById("onlineBox").onclick = ()=> popup.style.display = "block";
document.getElementById("closePopup").onclick = ()=> popup.style.display = "none";
dmCancel.onclick = ()=>{ dmTarget=null; dmHolder.style.display="none"; };

if(isAdmin){
  document.getElementById("clearChat").onclick = ()=> socket.emit("adminClearChat");
  document.getElementById("muteAll").onclick = ()=> socket.emit("adminMuteAll");
  document.getElementById("unmuteAll").onclick = ()=> socket.emit("adminUnmuteAll");
  document.getElementById("openAdminDash").onclick = ()=> adminDashboard.style.display = adminDashboard.style.display==="block" ? "none" : "block";
  socket.emit("adminRequestDmLogs");
}

socket.on("clearChatNow", ()=> messages.innerHTML = "");
socket.on("muteAllNow", ()=> showEvent("üîá All users muted"));
socket.on("unmuteAllNow", ()=> showEvent("üîä Users unmuted"));
socket.on("pinnedNow", text => { if(text) showEvent("üìå Pinned: "+text, 6000); });

socket.on("adminNewDM", m => {
  if(isAdmin){
    const row = document.createElement("div");
    row.className = "dm-list-item";
    row.textContent = m.from + " ‚Üí " + m.to + " ‚Ä¢ " + m.timestamp;
    row.onclick = ()=> {
      dmViewer.style.display = "block";
      dmViewer.innerHTML = "<h4>Conversation: "+m.from+" ‚Üî "+m.to+"</h4>";
      socket.emit("adminRequestDmLogs");
    };
    dmList.prepend(row);
  }
});

socket.on("adminDmLogs", logs => {
  dmList.innerHTML = "";
  logs.reverse().forEach(l => {
    const row = document.createElement("div");
    row.className = "dm-list-item";
    row.textContent = l.a + " ‚Üî " + l.b + " ‚Ä¢ started: " + l.started + " ‚Ä¢ msgs: " + l.count;
    row.onclick = () => {
      dmViewer.style.display = "block";
      dmViewer.innerHTML = "<h4>Conversation: "+l.a+" ‚Üî "+l.b+"</h4><div style='margin-top:8px;color:var(--muted)'>Metadata only (no message contents)</div>";
    };
    dmList.appendChild(row);
  });
  adminOnline.innerHTML = "";
  socket.emit("adminRequestDmLogs");
});

socket.on("adminUpdateOnline", list => {
  adminOnline.innerHTML = list.map(u => "<div style='padding:6px 0;border-bottom:1px solid #f2f2f2'>"+u+"</div>").join("");
});

document.getElementById("refreshDmLogs").onclick = ()=> socket.emit("adminRequestDmLogs");

function openReactionPopup(e, message, toggleFn){
  const pop = document.getElementById("reactionPopup");
  pop.style.left = (e.pageX - 60) + "px";
  pop.style.top = (e.pageY - 50) + "px";
  pop.style.display = "flex";
  [...pop.children].forEach(sp => { sp.onclick = () => { toggleFn(userId, sp.dataset.r); pop.style.display = "none"; }; });
  setTimeout(()=>{ document.body.onclick = ev => { if(!pop.contains(ev.target)) pop.style.display = "none"; }; },10);
}

window.addEventListener("click", ()=>{ if(document.getElementById("emojiPopup").style.display==="block"){ document.getElementById("emojiPopup").style.display="none"; } });
let lastPingTime = 0;


</script>
<div id="ping" class="ping-box">Ping: -- ms</div>
</body>
</html>
